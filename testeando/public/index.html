<!DOCTYPE html>
<!--
 *  Copyright (c) 2015 The WebRTC project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree.
-->
<html>

<head>
  <meta charset="utf-8" />
  <meta name="description" content="WebRTC code samples" />
  <meta itemprop="description" content="Client-side WebRTC code samples" />
  <meta itemprop="image" content="../../../images/webrtc-icon-192x192.png" />
  <meta itemprop="name" content="WebRTC code samples" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta id="theme-color" name="theme-color" content="#ffffff" />

  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <base target="_blank" />

  <title>WebCam Tool</title>

  <link href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>


  <style>
    div.select {
      display: inline-block;
      margin: 0 0 1em 0;
    }

    p.small {
      font-size: 0.7em;
    }

    label {
      width: 12em;
      display: inline-block;
    }
  </style>
</head>

<body>

  <div class="container-fluid">
    <h1>WebCam Tool</h1>
    <div class="select">
      <label for="videoSource">Video source: </label><select id="videoSource"></select>
    </div>
    <div class="row justify-content-between pr-5 mr-5">
      <div class="col-sm-3">

        <!-- 

        <video width="200" height="200" playsinline autoplay="true" id="video">
        </video>
        <video style="object-fit:cover; width:320px; height:240px" playsinline autoplay="true" id="video"></video>
        -->
        <div>
          <video id="video" playsinline style="object-fit:cover; width:320px; height:240px" autoplay></video>
        </div>


        <button onclick="capture()">Capture</button> <br> </br>

      </div>
      <div class="col-sm-4">

        <canvas id="canvas" style="overflow:auto"></canvas>
      </div>
    </div>
  </div>


  <div id="container">


  </div>

  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>


  <!--
      <div id="container">
        <video width="200" height="200" autoplay="true" id="video">
        </video>
      </div>
      <br></br>
      <p> Image Converted to String: </p>
      <p id="printresult"></p>
  -->





  <script>
    /*
var video = document.querySelector("#video");
if (navigator.mediaDevices.getUserMedia) {
 navigator.mediaDevices.getUserMedia({ video: true })
   .then(function (stream) {
     video.srcObject = stream;
   })
   .catch(function (err0r) {
     console.log("Something went wrong!");
   });
}
*/

    var resultb64 = "";
    function capture() {
      var canvas = document.getElementById("canvas");
      var video = document.getElementById("video");

      //canvas.style.display = "none";
      video.videoHeight = video.height;
      video.videoWidth = video.width;
      console.log(video.videoHeight);
      console.log(video.videoWidth);

      //canvas.width = video.width;
      //canvas.width = video.videoWidth;
      //canvas.width = video.videoWidth;
      //canvas.height = video.height;
      //canvas.height = video.videoHeight;
      //canvas.height = auto;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      canvas
        .getContext("2d")
        .drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
      resultb64 = canvas.toDataURL();
      //document.getElementById("printresult").innerHTML = canvas.toDataURL();
      //return data;
      console.log(resultb64);


      //const axios = require("axios").default;
      axios
        .post("/upload", {
          img: resultb64,
        })
        .then(function (response) {
          console.log(response);
        })
        .catch(function (error) {
          console.log(error);
        });
      /*
      axios
        .post("/upload", {
          img: resultb64,
        })
        .then(function (response) {
          console.log(response);
        })
        .catch(function (error) {
          console.log(error);
        });
        */

    }
    //document.getElementById("printresult").innerHTML = resultb64;

  </script>

  <script>
    /*
*  Copyright (c) 2015 The WebRTC project authors. All Rights Reserved.
*
*  Use of this source code is governed by a BSD-style license
*  that can be found in the LICENSE file in the root of the source
*  tree.
*/

    "use strict";

    const videoElement = document.querySelector("video");
    const videoSelect = document.querySelector("select#videoSource");
    const selectors = [videoSelect];

    function gotDevices(deviceInfos) {
      const values = selectors.map((select) => select.value);
      selectors.forEach((select) => {
        while (select.firstChild) {
          select.removeChild(select.firstChild);
        }
      });
      for (let i = 0; i !== deviceInfos.length; ++i) {
        const deviceInfo = deviceInfos[i];
        const option = document.createElement("option");
        option.value = deviceInfo.deviceId;

        if (deviceInfo.kind === "videoinput") {
          option.text = deviceInfo.label || `camera ${videoSelect.length + 1}`;
          videoSelect.appendChild(option);
        } else {
          console.log("Some other kind of source/device: ", deviceInfo);
        }
      }
      selectors.forEach((select, selectorIndex) => {
        if (
          Array.prototype.slice
            .call(select.childNodes)
            .some((n) => n.value === values[selectorIndex])
        ) {
          select.value = values[selectorIndex];
        }
      });
    }

    navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleError);



    function gotStream(stream) {
      window.stream = stream; // make stream available to console
      videoElement.srcObject = stream;
      // Refresh button list in case labels have become available
      return navigator.mediaDevices.enumerateDevices();
    }

    function handleError(error) {
      console.log(
        "navigator.MediaDevices.getUserMedia error: ",
        error.message,
        error.name
      );
    }

    function start() {
      if (window.stream) {
        window.stream.getTracks().forEach((track) => {
          track.stop();
        });
      }
      //const audioSource = audioInputSelect.value;
      const videoSource = videoSelect.value;
      const constraints = {
        //audio: { deviceId: audioSource ? { exact: audioSource } : undefined },
        video: {
          deviceId: videoSource ? { exact: videoSource } : undefined,

          width: { ideal: 640 },
          height: { ideal: 480 },
          //aspectRatio: 1.777777778,
          frameRate: { max: 30 },
          //facingMode: { exact: "user" }
        }
        ,
      };
      navigator.mediaDevices
        .getUserMedia(constraints)
        .then(gotStream)
        .then(gotDevices)
        .catch(handleError);
    }

    videoSelect.onchange = start;

    start();

  </script>
</body>

</html>